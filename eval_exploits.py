__author__ = 'Hyungjoon Koo'
import os
import pickle
import subprocess
from bz2 import BZ2File
import util

STAT_DIR = './stats/'
MOVED = '_stats_gads_movings.bz2'

'''
Exploit Samples with Metasploit and Evaluation
    (mplayer - avformat.dll)    66% (2/3 Broken)
    (mplayer - avcodec.dll)     Error in gadget generation!
    (integard_v2.2.0.9026 - integard32.dll) 62.5% (10/16 Broken)
    (alltomp3 - lame_enc.dll)   76.47% (13/17 Broken)
    (winamp - gen_ff.dll)
    (winamp - gen_ml.dll)
    (winamp - in_cdda.dll)
    (winamp - in_flv.dll)
    (winamp - in_midi.dll)
    (winamp - libsndfile.dll)
    (winamp - ml_disc.dll)
    (winamp - tataki.dll)
    (winamp - zlib.dll)
    (adboe reader - icucnv36.dll)
'''
EXPLOIT_GADS = {'avformat-52.dll': [0x649509B4, 0x64953AD6, 0x649ABC7B],
                'avcodec-52.dll': [0x6AD44B94, 0x6AD5130E, 0x6AD5C6FD, 0x6AD5C728, 0x6AD79CAC, 0x6AD9AC5C, 0x6AE62D12, 0x6AE8F378, 0x6AF1DCB5, 0x6AFA5EE9, 0x6AFCD525, 0x6B0402A9, 0x6B0B4113, 0x6B0B79D0, 0x6B0B79D2],
                'integard32.dll': [0x100106E6, 0x1001072D, 0x10010798, 0x100107E8, 0x100109B0, 0x10010A2A, 0x10010C69, 0x10010C6B, 0x10010EB5, 0x10010F0B, 0x100111B7, 0x100114C8, 0x1001274C, 0x10012EC7, 0x100137AB, 0x10013B9D],
                'lame_enc.dll': [0x1003176D, 0x1001FF5D, 0x1002B910, 0x1003176D, 0x1003C6A4, 0x1003C67A, 0x1003C696, 0x1002B23D, 0x1003303A, 0x10002388, 0x1003C6A4, 0x1003C6A4, 0x1003C6A4, 0x100023D1, 0x1003C696, 0x100023A8, 0x1003176D],
                'gen_ff.dll': [0x073CBBC1, 0x073EB7DD, 0x07405582, 0x0740B8F7],
                'gen_ml_mod.dll': [0x075B4067],
                'in_cdda_mod.dll': [0x07655ED6],
                'in_flv_mod.dll': [0x076C6AB3],
                'in_midi_mod.dll': [0x076F5D43],
                'libsndfile_mod.dll': [0x0709101A, 0x070911EC, 0x07091329, 0x0709E085, 0x070A7265, 0x070B7D10],
                'ml_disc_mod.dll': [0x078D1308, 0x078DD7C6, 0x078DD83A, 0x07966C74],
                'tataki_mod.dll': [0x071141A7],
                'zlib_mod.dll': [0x07143D8A],
                'icucnv36.dll': [0x4a801064, 0x4a801f90, 0x4a802196, 0x4a802ab1, 0x4a8063a5, 0x4a80a7d8, 0x4a80aedc, 0x4a80b692, 0x4a80cb38, 0x4a80d585, 0x4a842db2]
                }

def eval_exploits(target):
    t = BZ2File(STAT_DIR + target.split('/')[-1] + MOVED, 'rb')
    all_gads = pickle.load(t)
    all_brokens = pickle.load(t)
    all_remainings = pickle.load(t)
    all_movings = pickle.load(t)
    print "\tAll (Gads/Brokens/Remainings/Movings) = (%d, %d, %d, %d) with orp" \
          % (len(all_gads), len(all_brokens), len(all_remainings), len(all_movings))
    return all_movings

def get_gads_from_ROPgadget(target):
    p1 = subprocess.Popen(["python", "./ROPgadget/ROPgadget.py", "--all", "--binary", target], stdout=subprocess.PIPE)
    p2 = subprocess.Popen(["grep", "0x"], stdin=p1.stdout, stdout=subprocess.PIPE)
    output = p2.communicate()[0]
    all_potential_gads = [g.split(':')[0] for g in output.split('\n')]
    return all_potential_gads

def testing_with_remaining_gads(movings, gads, verbose=False):
    broken_cnt, remained_cnt = 0, 0
    for gad in gads:
        try:
            if type(gad) is type('str'):
                gad = int(gad, 16)
            (start, end) = util.get_addr_range(movings, gad)
            if start > 0 and start != gad:
                if verbose == True: print '\t\t0x%08X@[0x%08X:0x%08X]' % (gad, start, end)
                broken_cnt += 1
            else:
                if verbose == True: print '\t\t0x%08X@[0x%08X:0x%08X]*' % (gad, start, end)
                remained_cnt += 1
        except:
            pass
    return broken_cnt, remained_cnt

if __name__ == '__main__':
    targets = ["./exploit_tests/mplayer/avformat-52.dll",
               "./exploit_tests/integard_v2.2.0.9026/integard32.dll",
               "./exploit_tests/alltomp3/lame_enc.dll",
               "./exploit_tests/winamp_v5572/gen_ml_mod.dll", "./exploit_tests/winamp_v5572/in_cdda_mod.dll",
               "./exploit_tests/winamp_v5572/in_flv_mod.dll", "./exploit_tests/winamp_v5572/in_midi_mod.dll",
               "./exploit_tests/winamp_v5572/libsndfile_mod.dll", "./exploit_tests/winamp_v5572/ml_disc_mod.dll",
               "./exploit_tests/winamp_v5572/tataki_mod.dll", "./exploit_tests/winamp_v5572/zlib_mod.dll",
               "./exploit_tests/adobe_dc/icucnv36.dll"
                ]
    for target in targets:
        print "%s:" % target
        movings = eval_exploits(target)
        bc, rc = testing_with_remaining_gads(movings, get_gads_from_ROPgadget(target))
        print "\tBroken: %.2f%% (%d/%d) tested with ROPGadget samples" % ((bc/float(bc+rc))*100, bc, rc+bc)
        bc, rc = testing_with_remaining_gads(movings, EXPLOIT_GADS[target.split('/')[-1]], verbose=False)
        print "\tBroken: %.2f%% (%d/%d) tested with Metasploit samples" % ((bc/float(bc+rc))*100, bc, rc+bc)